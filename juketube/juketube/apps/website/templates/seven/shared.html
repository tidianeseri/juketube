{% extends "seven/base.html" %}
{% load i18n %}
{% block pagetitle %} {{playlist}} <span class="pull-right">Slug: <em>{{playlist.slug}}</em></span>{% endblock %}
{% block content %}
  <form id="toQueue" action="/updatePlaylist/" method="post">{% csrf_token %}
	  <input type="hidden" id="idmedia" name="idmedia">
	  <input type="hidden" id="title" name="title">
  	  <input type="hidden" id="length" name="length">
  	  <input type="hidden" id="position" name="position">
	  <input type="hidden" id="operation" name="operation">
	  <input type="hidden" id="playlist_id" name="playlist_id" value="{{playlist.id}}">
	  <input type="hidden" id="playlist_slug" name="playlist_slug" value="{{playlist.slug}}">
  </form>
  
<div class="row">
Currently listening: <span id="current-listeners"></span>
<span class="pull-right" id="connection-status"><em>Connecting...</em></span>
<button class="btn" id="ping">Ping</button>
</div>
<div class="row">
	<div class="col-md-3">
		<div class="widget-container fluid-height list green">
			<div class="heading">
				<i class="glyphicon glyphicon-list"></i>Search Results
			</div>
			<div class="widget-content padded">
				<table class="table table-filters table-list" id="results-table">
				</table>
			</div>
		</div>
	</div>

	<div class="col-md-6">
		<div class="widget-container fluid-height list green">
			<div class="heading">
				<span class="glyphicon glyphicon-facetime-video"></span>Video <span
					class="glyphicon glyphicon-step-forward pull-right"></span> <span
					class="glyphicon glyphicon-play pull-right"></span> <span
					class="glyphicon glyphicon-stop pull-right"></span> <span
					class="glyphicon glyphicon-step-backward pull-right"></span>
			</div>
			<div class="widget-content padded">
				<script type="text/javascript" src="/static/js/swfobject.js"></script>
				<div id="ytapiplayer">You need Flash player 8+ and JavaScript
					enabled to view this video.</div>
			</div>
			<div class="widget-content padded">
				<table class="table table-filters table-list table-playlist"
					id="playlist-table">
					{% for media in playlist.playlistmedia_set.all %}
					<tr id="{{ media.media.media_id }}">
						<td class="thumbvideo">
							<div class="arrow-left"></div>
							<a href='javascript:loadVideo("{{ media.media.media_id }}");'>
							<img src="http://i.ytimg.com/vi/{{ media.media.media_id }}/hqdefault.jpg" alt="Miniature" width="100%"></a>
						</td>
						<td class="track-title">
							<a href='javascript:loadVideo("{{ media.media.media_id }}",this);'>{{ media.media.name }}</a>
						</td>
						<td class="track-time"><h5>{{ media.media.time }}</h5></td>
						{% if is_listener %}<td><div class="cueButton"><a href='javascript:removeVideo("{{ media.media.id }}","{{ media.position }}");'><i class="icon-minus pull-right"></i></a></div></td>{% endif %}
					</tr>
					{% endfor %}
				</table>
			</div>
		</div>
	</div>

	<div class="col-md-3">
		<div class="widget-container fluid-height list">
			<div class="heading">
				<i class="glyphicon glyphicon-time"></i>Next Video
			</div>
			<div class="widget-content padded" id="next-video">
				<div class="next-video-img">
					<a href="#"><img src="http://i.ytimg.com/vi/{{ playlist.medias.all.0.media_id }}/hqdefault.jpg" alt="Next Video" width="100%"></a>
				</div>
				<div class="next-video-infos">
					<a href="#"><strong>{{ playlist.medias.all.0 }}</strong></a>
					<h5>{{ playlist.medias.all.0.time }}</h5>
				</div>
			</div>

			<table class="table table-filters table-list" id="playlist-table2">
			{% for media in playlist.playlistmedia_set.all %}
				<tr id="{{ media.media.media_id }}">
				<td class="thumbvideo">
					<div class="arrow-left"></div>
					<a href='javascript:loadVideo("{{ media.media.media_id }}");'>
					<img src="http://i.ytimg.com/vi/{{ media.media.media_id }}/hqdefault.jpg" alt="Miniature" width="100%">
					</a>
				</td>
				<td class="track-title"><a href='javascript:loadVideo("{{ media.media.media_id }}");'>{{ media.media.name }}</a></td>
				<td class="track-time"><h5>{{ media.media.time }}</h5></td>
				{% if is_listener %}<td><div class="cueButton"><a href='javascript:removeVideo("{{ media.media.id }}","{{ media.position }}");'><i class="icon-minus pull-right"></i></a></div></td>{% endif %}
				</tr>
			{% endfor %}
			</table>
		</div>
	</div>
</div>
</div>

<div class="row" id="about">
<h1>Settings</h1>
	<div class="col-md-6">
		<div class="well">
			<p>Name: {{playlist}}
			<p>Public: {{playlist.public}}
			<p>{{playlist.medias.count}} Medias
		</div>
	</div>
	<div class="col-md-6">
		<div class="well">
			<h3>Creator: <a href="#">{{playlist.creator}}</a></h3>
			<p>Registered: 
			{% for listener in playlist.listeners.all %}
			<a href="#">{{ listener }} </a>
			{% endfor %}
		</div>
	</div>
</div>

{% endblock %}

{% block pagejs %}
<script type="text/javascript">
//player = new YoutubePlayer("ytapiplayer");
	var tag = document.createElement('script');

	tag.src = "https://www.youtube.com/iframe_api";
	var firstScriptTag = document.getElementsByTagName('script')[0];
	firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
	
	var ytplayer;
	function onYouTubeIframeAPIReady() {
	  ytplayer = new YT.Player('ytapiplayer', {
	    height: 'auto',
	    width: 'auto',
	    videoId: '{{ playlist.medias.all.0.media_id }}',
    	events: {
            'onReady': onYouTubePlayerReady,
            'onStateChange': onytplayerStateChange
          }
	  });
	}
</script>
<script src="/static/seven/js/juketube.js" type="text/javascript"></script>
{% endblock %}

{% block headjs %}
{% if playlist.editable %}
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js" type="text/javascript"></script>
<script src="http://localhost:4000/socket.io/socket.io.js"></script>
<script>
	var socket = io.connect('/', {
		port : 4000
	});
	var playlist_slug = "{{playlist.slug}}";

	socket.on('connect', function() {
		$('#connection-status').html("<em>Connected<em>");
		console.log("connected");
		socket.emit('playlist', playlist_slug);
		socket.emit('new-user', '{{user}}');
	});

	socket.on('refresh', function(message) {
		refreshPlaylist("{{playlist.id}}");
	});
	
	socket.on('users-list', function(list) {
		var user_list = "";
		for (var key in list) {
			   var obj = list[key];
			   user_list = user_list + "<a href='#'> " + obj +"</a>,";
			}
		$("#current-listeners").html(user_list.slice(0, -1));
	});
	
	socket.on('rcv_command', function(func, param) {
		//Create the function
		var fn = window[func];
		 
		//Call the function
		fn(param);
	});

	$(document).ready(function() {

		var entry_el = $('#ping');
		//console.log(entry_el);

		entry_el.click(function() {
			//When enter is pressed send input value to node server
			var msg = "{{playlist.slug}}";
			//console.log("msg envoye");
			if (msg) {
				socket.emit('send_command', msg, "loadVideo", "t7M89YJAPhM");
			}
		});
	});
</script>
{% endif %}
{% endblock %}